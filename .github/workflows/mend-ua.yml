name: Mend CLI UA

on: workflow_dispatch

jobs:
  cli:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudunits2-dev
          
      - name: Install packages
        run: |
          Rscript -e 'install.packages("remotes", repos = "https://cloud.r-project.org")'
          Rscript -e 'remotes::install_deps(dependencies = TRUE)'

      - name: Mend CLI Scan
        env:
          MEND_EMAIL: ${{secrets.MEND_EMAIL}}
          MEND_USER_KEY: ${{secrets.MEND_USER_KEY}}
          MEND_URL: https://saas.mend.io
          MEND_LOG_LEVEL: DEBUG
        run: |
          echo Downloading Mend CLI
          curl https://downloads.mend.io/cli/linux_amd64/mend -o /usr/local/bin/mend && chmod +x /usr/local/bin/mend
          echo run Mend scan
          mend ua -project absmapsdata -product Packrat -wss.url https:/saas.mend.io/agent
        
      - name: 'Upload .mend/logs folder'
        uses: actions/upload-artifact@v4
        with:
          name: Mend logs
          path: /home/runner/.mend/logs/
          retention-days: 1
